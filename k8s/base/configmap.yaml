apiVersion: v1
kind: ConfigMap
metadata:
  name: eventflow-config
  namespace: eventflow
data:
  # Database
  DATABASE_HOST: "postgres"
  DATABASE_PORT: "5432"
  DATABASE_NAME: "analytics"
  
  # Redis
  REDIS_HOST: "redis"
  REDIS_PORT: "6379"
  
  # Celery
  CELERY_BROKER_DB: "1"
  
  # OpenTelemetry
  OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4317"
  OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
  OTEL_TRACES_EXPORTER: "otlp"
  OTEL_METRICS_EXPORTER: "otlp"
  OTEL_LOGS_EXPORTER: "otlp"
  OTEL_PYTHON_LOG_CORRELATION: "true"
  
  # CORS
  CORS_ORIGINS: "https://sudhanshu.anlytics.dev,http://localhost:5173"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: eventflow
data:
  otel-collector-config.yaml: |
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
            cors:
              allowed_origins:
                - "*"
              allowed_headers:
                - "*"

    processors:
      batch:
        timeout: 1s
        send_batch_size: 1024
      
      memory_limiter:
        check_interval: 1s
        limit_mib: 400
        spike_limit_mib: 100

      resource:
        attributes:
          - key: deployment.environment
            from_attribute: DEPLOYMENT_ENV
            action: upsert

    exporters:
      debug:
        verbosity: basic

      otlp/jaeger:
        endpoint: jaeger-collector:4317
        tls:
          insecure: true

      prometheus:
        endpoint: 0.0.0.0:8889
        namespace: eventflow

    extensions:
      health_check:
        endpoint: 0.0.0.0:13133

    service:
      extensions: [health_check]
      
      pipelines:
        traces:
          receivers: [otlp]
          processors: [memory_limiter, batch, resource]
          exporters: [otlp/jaeger]
        
        metrics:
          receivers: [otlp]
          processors: [memory_limiter, batch, resource]
          exporters: [prometheus]
        
        logs:
          receivers: [otlp]
          processors: [memory_limiter, batch, resource]
          exporters: [debug]

      telemetry:
        logs:
          level: info
